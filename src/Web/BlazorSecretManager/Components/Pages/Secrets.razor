@page "/secrets"
@using BlazorSecretManager.Entities
@using BlazorSecretManager.Services

<PageTitle>Secrets</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudPaper Elevation="0" Style="padding: 10px;" >
        <MudStack Class="d-flex justify-end flex-grow-1 gap-4" Row="true" @onkeypress="SearchKeyUp">
            <MudTextField T="string" Label="Title" @bind-Value="_title" Clearable="true"/>
            <MudTextField T="string" Label="Description" @bind-Value="_description" Clearable="true"/>
        </MudStack>
        <br/>
        <MudPaper Class="d-flex justify-end flex-grow-1 gap-4" Elevation="0">
            <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Success" OnClick="this._dataGrid.ReloadServerData">Search</MudButton>
            <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Success" OnClick="this._dataGrid.ReloadServerData">New</MudButton>
            <MudButton Variant="Variant.Filled" Size="Size.Small" Color="Color.Success" OnClick="this._dataGrid.ReloadServerData">Delete</MudButton>
        </MudPaper>
    </MudPaper>

    <br/>
    
    <MudDataGrid T="Secret"
                 ServerData="ServerData"
                 Dense="true"
                 Filterable="false"
                 SortMode="SortMode.None"
                 Height="960px"
                 RowStyleFunc="RowStyleFunc"
                 RowClick="Callback"
                 @ref="_dataGrid">
        <Columns>
            <PropertyColumn Property="m => m.Id"/>
            <PropertyColumn Property="m => m.Title"/>
            <PropertyColumn Property="m => m.Description"/>
            <PropertyColumn Property="m => m.CreatedAt"/>
            <PropertyColumn Property="m => m.UpdatedAt"/>
            <TemplateColumn>
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Update"/>
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"/>
                </CellTemplate>
            </TemplateColumn>
        </Columns>
    </MudDataGrid>
</MudContainer>

@inject ISecretRepository SecretRepository
@code {
    Secret _selectedItem;
    MudDataGrid<Secret> _dataGrid;
    string _title;
    string _description;
    
    private async Task<GridData<Secret>> ServerData(GridState<Secret> arg)
    {
        var result = await this.SecretRepository.GetSecrets(arg.Page, arg.PageSize);
        return new GridData<Secret>()
        {
            TotalItems = result.Item1,
            Items = result.Item2
        };
    }

    private string RowStyleFunc(Secret arg1, int arg2)
    {
        return arg1 == _selectedItem ? "background-color: #cce4ff;" : string.Empty;
    }

    private void Callback(DataGridRowClickEventArgs<Secret> obj)
    {
        this._selectedItem = obj.Item;
    }

    async Task SearchKeyUp(KeyboardEventArgs e)
    {
        if (e.Code is "Enter" or "NumpadEnter")
        {
            await this._dataGrid.ReloadServerData();
        }
    }
}